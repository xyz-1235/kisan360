<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kisan360 | The Complete Farmer Ecosystem</title>
    
    <!-- External Icons (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link href="style.css" rel="stylesheet">
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand">
            <i class="fas fa-leaf"></i>
            <span>Kisan360</span>
        </div>

        <div class="nav-links">
            <div class="nav-item active" onclick="navigate('dashboard')" data-section="dashboard">
                <i class="fas fa-th-large"></i> <span data-lang-key="dashboard">Dashboard</span>
            </div>
            <div class="nav-item" onclick="navigate('doctor')" data-section="doctor">
                <i class="fas fa-microscope"></i> <span data-lang-key="doctor">AI Crop Doctor</span>
            </div>
            <div class="nav-item" onclick="navigate('market')" data-section="market">
                <i class="fas fa-chart-line"></i> <span data-lang-key="market">Mandi Rates</span>
            </div>
            <div class="nav-item" onclick="navigate('finance')" data-section="finance">
                <i class="fas fa-calculator"></i> <span data-lang-key="finance">Loans & Schemes</span>
            </div>
            <!-- NEW SECTION: EQUIPMENT -->
            <div class="nav-item" onclick="navigate('equipment')" data-section="equipment">
                <i class="fas fa-tractor"></i> <span data-lang-key="equipment">Equipments</span>
            </div>
            <!-- NEW SECTION: MY SHOP -->
            <div class="nav-item" onclick="navigate('myshop')" data-section="myshop">
                <i class="fas fa-store-alt"></i> <span data-lang-key="myshop">Sell Produce</span>
            </div>
            <div class="nav-item" onclick="navigate('learn')" data-section="learn">
                <i class="fas fa-graduation-cap"></i> <span data-lang-key="learn">Learning Hub</span>
            </div>
            <div class="nav-item" onclick="navigate('community')" data-section="community">
                <i class="fas fa-users"></i> <span data-lang-key="community">Community</span>
            </div>
        </div>

        <div class="user-profile">
            <div class="user-avatar">JP</div>
            <div>
                <p style="font-size: 14px; font-weight: 600;">Jai Pandey</p>
                <p style="font-size: 12px; color: rgba(255,255,255,0.7);">Pro Farmer</p>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <!-- HEADER -->
        <header>
            <div class="header-title">
                <h2 id="page-title">Dashboard</h2>
                <p id="page-subtitle">Welcome back, here is your daily farming overview.</p>
            </div>
            <!-- UPDATED LANGUAGE SWITCHER -->
            <div class="lang-switch">
                <button onclick="setLanguage('en')" id="btn-en" class="active">EN</button>
                <button onclick="setLanguage('mr')" id="btn-mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</button>
                <button onclick="setLanguage('hi')" id="btn-hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
            </div>
        </header>

        <!-- 1. DASHBOARD PAGE -->
        <section id="dashboard" class="section-page active">
            <div class="card-grid">
                <div class="card weather-card">
                    <div class="card-info">
                        <h3 id="weatherTemp">--¬∞C</h3>
                        <p id="weatherDesc" style="color: var(--text-dark); margin-bottom: 5px; font-weight: 500;">--</p>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                            üìç <span id="weatherLocation">Your Location</span>
                        </p>
                    </div>
                    <div class="card-icon c-blue">
                        <i id="weatherIcon" class="fas fa-cloud-sun"></i>
                    </div>
                </div>
                <div class="card">
                    <div class="card-info">
                        <h3>‚Çπ2,450</h3>
                        <p>Onion Price / q</p>
                    </div>
                    <div class="card-icon c-green"><i class="fas fa-rupee-sign"></i></div>
                </div>
                <div class="card">
                    <div class="card-info">
                        <h3>Good</h3>
                        <p>Soil Health</p>
                    </div>
                    <div class="card-icon c-blue"><i class="fas fa-seedling"></i></div>
                </div>
            </div>

            <h3 style="margin-bottom: 20px; color: var(--text-dark);">Recent Alerts</h3>
            <div style="background: white; padding: 20px; border-radius: 15px; border-left: 5px solid #e74c3c; box-shadow: var(--shadow);">
                <h4 style="color: #e74c3c; margin-bottom: 5px;"><i class="fas fa-exclamation-circle"></i> Pest Alert</h4>
                <p style="color: var(--text-light);">Heavy Locust activity spotted in Nashik district. Ensure crops are covered.</p>
            </div>
        </section>

        <!-- 2. UPDATED CROP DOCTOR PAGE -->
        <section id="doctor" class="section-page">
            <div class="doctor-layout">
                <!-- Left: Inputs & Samples -->
                <div class="doctor-input-col">
                    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Upload Photo</h3>
                        <p style="font-size: 13px; color: var(--text-light);">From Gallery or Camera</p>
                        <input type="file" id="fileInput" accept="image/*" hidden onchange="handleImageUpload(this)">
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: var(--text-dark); font-size: 14px;">Or Select Demo Scenario:</h4>
                        <div class="sample-grid">
                            <div class="sample-thumb" onclick="selectSample('healthy', this)">
                                <i class="fas fa-leaf" style="color: #2ecc71;"></i>
                                <span>Healthy</span>
                            </div>
                            <div class="sample-thumb" onclick="selectSample('nitrogen', this)">
                                <i class="fas fa-leaf" style="color: #f1c40f;"></i>
                                <span>Yellowing</span>
                            </div>
                            <div class="sample-thumb" onclick="selectSample('rust', this)">
                                <i class="fas fa-leaf" style="color: #e67e22;"></i>
                                <span>Spots</span>
                            </div>
                            <div class="sample-thumb" onclick="selectSample('pest', this)">
                                <i class="fas fa-bug" style="color: #e74c3c;"></i>
                                <span>Pest</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Preview & Result -->
                <div class="doctor-preview-col">
                    <div class="scan-frame" id="scanFrame">
                        <div class="scan-line"></div>
                        <i class="fas fa-leaf big-icon" id="previewIcon"></i>
                        <p class="placeholder-text" id="previewText">Select a scenario to start</p>
                    </div>

                    <button class="btn-primary" id="analyzeBtn" onclick="startAnalysis()" style="width: 100%;" disabled>
                        Run AI Analysis
                    </button>

                    <!-- Dynamic Result Card -->
                    <div class="diagnosis-card" id="scanResult">
                        <div class="result-header" style="margin-top: 25px;">
                            <div>
                                <h3 id="resTitle" style="color: var(--text-dark);">Diagnosis Name</h3>
                                <p id="resSeverity" style="font-size: 13px; color: #e74c3c;">Severity: High</p>
                            </div>
                            <span class="confidence-badge" id="resConfidence">98% Match</span>
                        </div>
                        <p id="resDesc" style="font-size: 14px; color: var(--text-light); line-height: 1.5;">
                            Description of the disease goes here.
                        </p>
                        <div class="treatment-box">
                            <h4><i class="fas fa-first-aid"></i> Recommended Treatment</h4>
                            <ul id="resTreatment">
                                <li>Treatment 1</li>
                                <li>Treatment 2</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. MARKET PAGE -->
        <section id="market" class="section-page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Live Mandi Rates</h3>
                <button class="btn-primary" onclick="fetchMandiRates()" style="width: auto;"><i class="fas fa-sync"></i> Refresh Rates</button>
            </div>
            
            <!-- Dynamic Mandi Rates Container -->
            <div id="mandiRatesContainer" style="background: white; border-radius: 20px; box-shadow: var(--shadow); padding: 25px;">
                <p style="text-align: center; padding: 40px; color: var(--text-light);">
                    üìä Loading latest market rates...
                </p>
            </div>
        </section>

        <!-- 4. FINANCE PAGE -->
        <section id="finance" class="section-page">
            <div class="doctor-layout">
                <div class="calc-container">
                    <h3>Loan Eligibility Calculator</h3>
                    <p style="margin-bottom: 20px; color: var(--text-light);">Based on Scale of Finance 2026</p>
                    
                    <div class="form-group">
                        <label>Land Size (Acres)</label>
                        <input type="number" id="landInput" placeholder="e.g. 2.5">
                    </div>
                    <div class="form-group">
                        <label>Crop Type</label>
                        <select id="cropInput">
                            <option value="35000">Wheat / Gahu</option>
                            <option value="45000">Onion / Kanda</option>
                            <option value="120000">Sugarcane / Us</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="calculateLoan()">Check Eligibility</button>
                    
                    <div id="loanResult" style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; display: none;">
                        <strong>Max Loan Amount:</strong> <span id="amountDisplay">‚Çπ0</span><br>
                        <small>Interest: 4% p.a. (Under KCC Scheme)</small>
                    </div>
                </div>

                <div>
                    <h3>Active Gov. Schemes 2026</h3>
                    <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: var(--shadow);">
                        <h4>PM-Kisan Samman</h4>
                        <p style="font-size: 13px; color: var(--text-light);">‚Çπ6,000 per year income support.</p>
                        <a href="#" style="color: var(--secondary-color); font-size: 13px; font-weight: bold;">Apply Now ‚Üí</a>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow);">
                        <h4>Magel Tyala Shettale</h4>
                        <p style="font-size: 13px; color: var(--text-light);">Subsidy for farm ponds.</p>
                        <a href="#" style="color: var(--secondary-color); font-size: 13px; font-weight: bold;">Apply Now ‚Üí</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. NEW: EQUIPMENT STORE -->
        <section id="equipment" class="section-page">
            
    <div id="confetti" class="confetti-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMsg">Action completed successfully</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>üöú Equipment Hub</h1>
            <div class="tabs">
                <button class="tab active" data-filter="all">All Equipment</button>
                <button class="tab" data-filter="rent">Rentals</button>
                <button class="tab" data-filter="buy">Buy Used</button>
            </div>
        </div>

        <div class="cards-grid" id="cardsContainer">
            <!-- Cards generated by JS -->
        </div>
        
        <!-- Booked Equipment Section -->
        <div class="booked-section" id="bookedSection">
            <h2><i class="fas fa-clipboard-list"></i> Your Bookings</h2>
            <div class="booked-grid" id="bookedContainer">
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--light); background: var(--white); border-radius: 12px; border: 2px dashed var(--border);">
                    <i class="fas fa-tractor" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>You haven't booked any equipment yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-box">
            
            <!-- FORM VIEW -->
            <div id="formView">
                <div class="modal-header">
                    <h2 id="modalTitle"><i class="fas fa-calendar-plus"></i> Book Equipment</h2>
                    <button class="close" onclick="closeModal()">&times;</button>
                </div>

                <form id="bookingForm" onsubmit="submitForm(event)">
                    <div class="form-group">
                        <label>Your Name</label>
                        <input type="text" id="name" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="phone" placeholder="10-digit mobile number" pattern="[0-9]{10}" required>
                    </div>

                    <div class="form-group">
                        <label>Required Date</label>
                        <input type="date" id="date" required>
                    </div>

                    <!-- Rental specific fields -->
                    <div id="rentFields">
                        <div class="form-group">
                            <label>Duration / Quantity</label>
                            <input type="number" id="quantity" value="1" min="1" oninput="updatePrice()">
                        </div>

                        <div class="price-box">
                            <div class="price-row">
                                <span>Rate:</span>
                                <strong id="unitPrice">‚Çπ0</strong>
                            </div>
                            <div class="price-row total">
                                <span>Total Estimated:</span>
                                <strong id="totalPrice">‚Çπ0</strong>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="notes" placeholder="Any specific requirements?"></textarea>
                    </div>

                    <div class="buttons">
                        <button type="submit" class="btn-confirm" id="confirmBtn">
                            Confirm Booking
                        </button>
                        <button type="button" class="btn-cancel" onclick="closeModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- CONFIRMATION VIEW -->
            <div id="confirmView" class="confirmation">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="conf-title" id="confHead">Success!</h2>
                <p class="conf-subtitle" id="confSub">Your request has been processed successfully.</p>
                
                <div class="details-list" id="confDetails">
                    <!-- Details injected via JS -->
                </div>

                <button class="btn" onclick="closeModal()">Back to Hub</button>
            </div>

        </div>
    </div>

    <script>
        // Data
        const equipmentData = [
            { id: 1, name: 'Mahindra 575 DI', type: 'rent', icon: 'fa-tractor', price: 600, unit: '/hr', specs: '45 HP ‚Ä¢ Rotavator Included ‚Ä¢ Diesel' },
            { id: 2, name: 'Agri Drone Sprayer', type: 'rent', icon: 'fa-plane-departure', price: 1200, unit: '/acre', specs: '10L Capacity ‚Ä¢ Pilot Included ‚Ä¢ Precision Spraying' },
            { id: 3, name: 'Drip Irrigation Kit', type: 'buy', icon: 'fa-water', price: 15000, unit: '', specs: '1 Acre Full Set ‚Ä¢ Used 1 year ‚Ä¢ Good Condition' },
            { id: 4, name: 'Harvest Pickup', type: 'rent', icon: 'fa-truck-pickup', price: 25, unit: '/km', specs: 'Tata Ace ‚Ä¢ 1 Ton Capacity ‚Ä¢ Driver Included' },
            { id: 5, name: 'Rotavator 6ft', type: 'buy', icon: 'fa-fan', price: 35000, unit: '', specs: 'Heavy Duty ‚Ä¢ 42 Blades ‚Ä¢ 2 Years Old' },
            { id: 6, name: 'Power Tiller', type: 'rent', icon: 'fa-dharmachakra', price: 400, unit: '/hr', specs: 'Petrol Engine ‚Ä¢ Easy Handling ‚Ä¢ With Attachments' }
        ];

        let selectedItem = null;
        let bookings = [];

        // Initialization
        window.addEventListener('DOMContentLoaded', () => {
            renderCards('all');
            setupTabs();
            
            // Set min date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').min = today;
            document.getElementById('date').value = today;
        });

        // Core Functions
        function renderCards(filter) {
            const container = document.getElementById('cardsContainer');
            const items = filter === 'all' ? equipmentData : equipmentData.filter(e => e.type === filter);
            
            container.innerHTML = items.map(item => `
                <div class="card">
                    <div class="card-header">
                        <i class="fas ${item.icon}"></i>
                        <span class="tag ${item.type}">${item.type === 'buy' ? 'Buy Used' : 'Rent'}</span>
                    </div>
                    <div class="card-content">
                        <h3>${item.name}</h3>
                        <div class="price">‚Çπ${item.price.toLocaleString()}<span style="font-size:14px; font-weight:500; color:#7f8c8d">${item.unit}</span></div>
                        <div class="specs">${item.specs}</div>
                        <button class="btn" onclick="openModal(${item.id})">
                            <i class="fas ${item.type === 'buy' ? 'fa-phone' : 'fa-calendar-check'}"></i>
                            ${item.type === 'buy' ? 'Contact Seller' : 'Book Now'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    renderCards(e.target.dataset.filter);
                });
            });
        }

        // Modal Logic
        function openModal(id) {
            selectedItem = equipmentData.find(e => e.id === id);
            const modal = document.getElementById('modal');
            const formView = document.getElementById('formView');
            const confirmView = document.getElementById('confirmView');
            const rentFields = document.getElementById('rentFields');
            const title = document.getElementById('modalTitle');
            const btn = document.getElementById('confirmBtn');

            // Reset UI
            formView.style.display = 'block';
            confirmView.classList.remove('show');
            document.getElementById('bookingForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];

            // Configure based on type
            if (selectedItem.type === 'buy') {
                title.innerHTML = `<i class="fas fa-phone"></i> Contact Seller`;
                rentFields.style.display = 'none';
                btn.innerHTML = `Request Callback`;
            } else {
                title.innerHTML = `<i class="fas fa-calendar-check"></i> Book ${selectedItem.name}`;
                rentFields.style.display = 'block';
                btn.innerHTML = `Confirm Booking`;
                document.getElementById('unitPrice').textContent = `‚Çπ${selectedItem.price} ${selectedItem.unit}`;
                updatePrice();
            }

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function updatePrice() {
            if (!selectedItem || selectedItem.type === 'buy') return;
            const qty = document.getElementById('quantity').value || 1;
            const total = selectedItem.price * qty;
            document.getElementById('totalPrice').textContent = `‚Çπ${total.toLocaleString()}`;
        }

        // Form Handling
        function submitForm(e) {
            e.preventDefault();
            const btn = document.getElementById('confirmBtn');
            
            // Loading state
            btn.classList.add('loading');
            btn.textContent = 'Processing...';

            // Simulate API call
            setTimeout(() => {
                const formData = {
                    id: Date.now(),
                    itemId: selectedItem.id,
                    itemName: selectedItem.name,
                    icon: selectedItem.icon,
                    type: selectedItem.type,
                    customer: document.getElementById('name').value,
                    date: document.getElementById('date').value,
                    quantity: document.getElementById('quantity').value,
                    total: selectedItem.type === 'buy' ? selectedItem.price : (selectedItem.price * document.getElementById('quantity').value)
                };

                bookings.push(formData);
                updateBookedList();
                
                // Switch to success view
                showSuccessView(formData);
                
                // Show confetti
                fireConfetti();
                
                // Reset button
                btn.classList.remove('loading');
            }, 800);
        }

        function showSuccessView(data) {
            const formView = document.getElementById('formView');
            const confirmView = document.getElementById('confirmView');
            const details = document.getElementById('confDetails');
            const title = document.getElementById('confHead');
            const sub = document.getElementById('confSub');

            formView.style.display = 'none';
            confirmView.classList.add('show');

            if (data.type === 'buy') {
                title.textContent = 'Interest Registered!';
                sub.textContent = 'The seller has been notified and will call you shortly.';
                details.innerHTML = `
                    <div class="detail-item"><span>Equipment</span><span>${data.itemName}</span></div>
                    <div class="detail-item"><span>Price</span><span>‚Çπ${data.total.toLocaleString()}</span></div>
                    <div class="detail-item"><span>Your Number</span><span>${document.getElementById('phone').value}</span></div>
                `;
            } else {
                title.textContent = 'Booking Confirmed!';
                sub.textContent = 'Your equipment has been reserved successfully.';
                details.innerHTML = `
                    <div class="detail-item"><span>Equipment</span><span>${data.itemName}</span></div>
                    <div class="detail-item"><span>Date</span><span>${data.date}</span></div>
                    <div class="detail-item"><span>Duration</span><span>${data.quantity} ${selectedItem.unit.replace('/','')}</span></div>
                    <div class="detail-item"><span>Total Cost</span><span>‚Çπ${data.total.toLocaleString()}</span></div>
                `;
            }
        }

        // Booked List Logic
        function updateBookedList() {
            const container = document.getElementById('bookedContainer');
            
            if (bookings.length === 0) {
                container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--light); background: var(--white); border-radius: 12px; border: 2px dashed var(--border);">
                    <i class="fas fa-tractor" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>You haven't booked any equipment yet.</p>
                </div>`;
                return;
            }

            container.innerHTML = bookings.map(b => `
                <div class="booked-card ${b.type === 'buy' ? 'buy-type' : ''}">
                    <div class="booked-content">
                        <div class="booked-icon" style="color: ${b.type === 'buy' ? 'var(--accent)' : 'var(--primary)'}">
                            <i class="fas ${b.icon}"></i>
                        </div>
                        <div class="booked-info">
                            <h4>${b.itemName}</h4>
                            <p><strong>Ref:</strong> #${b.id.toString().slice(-6)}</p>
                            <p><strong>Date:</strong> ${b.date}</p>
                            <p><strong>Status:</strong> ${b.type === 'buy' ? 'Seller Contacted' : 'Reserved'}</p>
                            <p style="color:var(--dark); font-weight:700; margin-top:4px">‚Çπ${b.total.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="booked-actions">
                        <button class="cancel-btn" onclick="cancelBooking(${b.id})">
                            <i class="fas fa-times-circle"></i> Cancel Booking
                        </button>
                    </div>
                </div>
            `).join('');

            // Scroll to section
            document.getElementById('bookedSection').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelBooking(id) {
            if(confirm("Are you sure you want to cancel this booking?")) {
                bookings = bookings.filter(b => b.id !== id);
                updateBookedList();
                showToast("Booking cancelled successfully");
            }
        }

        // Utilities
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function fireConfetti() {
            const container = document.getElementById('confetti');
            const colors = ['#2ecc71', '#3498db', '#f1c40f', '#e74c3c'];
            
            for(let i=0; i<50; i++) {
                const conf = document.createElement('div');
                conf.classList.add('confetti-piece');
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                conf.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
                container.appendChild(conf);
            }
            
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
        </section>
<!-- 6. NEW: MY SHOP (Direct to Buyer) -->
        <section id="myshop" class="section-page">
            <div class="shop-split">
                <!-- Add Listing Form -->
                <div class="calc-container">
                    <h3><i class="fas fa-plus-circle"></i> Add New Listing</h3>
                    <p style="font-size: 13px; color: #777; margin-bottom: 15px;">Buyers will see this instantly.</p>
                    
                    <div class="form-group">
                        <label>Crop Name</label>
                        <select>
                            <option>Onion</option>
                            <option>Tomato</option>
                            <option>Wheat</option>
                            <option>Soybean</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity (Quintals)</label>
                        <input type="number" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label>Expected Price (per Qtl)</label>
                        <input type="number" placeholder="2500">
                    </div>
                    <div class="form-group">
                        <label>Photo</label>
                        <div style="border: 1px dashed #ccc; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer;">
                            <i class="fas fa-camera"></i> Upload
                        </div>
                    </div>
                    <button class="btn-primary" onclick="alert('Listing Published Successfully!')">Publish Listing</button>
                </div>

                <!-- Active Listings -->
                <div>
                    <h3>Your Active Listings</h3>
                    
                    <div class="listing-card">
                        <div class="l-img"><i class="fas fa-carrot" style="color: orange; font-size: 30px;"></i></div>
                        <div style="flex: 1;">
                            <h4>Red Onion (Nashik)</h4>
                            <p style="font-size: 13px; color: #555;">50 Quintals ‚Ä¢ ‚Çπ2,400/qtl</p>
                            <span style="font-size: 11px; color: green; background: #e8f5e9; padding: 2px 6px; border-radius: 4px;">Live</span>
                        </div>
                        <button style="border: none; background: #eee; padding: 8px; border-radius: 5px; cursor: pointer;"><i class="fas fa-trash"></i></button>
                    </div>

                    <div class="listing-card">
                        <div class="l-img"><i class="fas fa-leaf" style="color: green; font-size: 30px;"></i></div>
                        <div style="flex: 1;">
                            <h4>Fenugreek (Methi)</h4>
                            <p style="font-size: 13px; color: #555;">200 Bundles ‚Ä¢ ‚Çπ15/bundle</p>
                            <span style="font-size: 11px; color: green; background: #e8f5e9; padding: 2px 6px; border-radius: 4px;">Live</span>
                        </div>
                        <button style="border: none; background: #eee; padding: 8px; border-radius: 5px; cursor: pointer;"><i class="fas fa-trash"></i></button>
                    </div>

                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; border-left: 4px solid #3498db;">
                        <strong>Buyer Request:</strong>
                        <p style="font-size: 13px;">BigBasket agent looking for 100Q Potato. <a href="#">Connect</a></p>
                    </div>
                </div>
            </div>
        </section>
        <!-- 7. LEARNING HUB -->
        <section id="learn" class="section-page">
            <div class="video-grid">
                <div class="video-card">
                    <div class="vid-thumb" style="background: #2c3e50;"><i class="fas fa-play-circle" style="color: white;"></i></div>
                    <div class="vid-info">
                        <span>Organic</span>
                        <h4>Zero Budget Natural Farming</h4>
                        <p style="font-size: 12px; color: #888;">By Subhash Palekar ‚Ä¢ 12 mins</p>
                    </div>
                </div>
                <div class="video-card">
                    <div class="vid-thumb" style="background: #34495e;"><i class="fas fa-play-circle" style="color: white;"></i></div>
                    <div class="vid-info">
                        <span>Tech</span>
                        <h4>Drip Irrigation Setup</h4>
                        <p style="font-size: 12px; color: #888;">Jain Irrigation ‚Ä¢ 20 mins</p>
                    </div>
                </div>
                <div class="video-card">
                    <div class="vid-thumb" style="background: #1abc9c;"><i class="fas fa-play-circle" style="color: white;"></i></div>
                    <div class="vid-info">
                        <span>Market</span>
                        <h4>Export Quality Packaging</h4>
                        <p style="font-size: 12px; color: #888;">APEDA Guide ‚Ä¢ 15 mins</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. COMMUNITY -->
        <section id="community" class="section-page">
            <div style="background: white; padding: 30px; border-radius: 20px; text-align: center; box-shadow: var(--shadow);">
                <i class="fas fa-comments" style="font-size: 50px; color: var(--secondary-color); margin-bottom: 20px;"></i>
                <h3>Farmer's Chaupal</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">Connect with 5000+ farmers in Pune district.</p>
                <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                    <div style="border-bottom: 1px solid #eee; padding: 15px 0;">
                        <strong>Ramesh P. (Baramati)</strong> asked:
                        <p>"Best fertilizer for onions in late Kharif season?"</p>
                        <small style="color: var(--secondary-color);">2 Replies ‚Ä¢ 10 mins ago</small>
                    </div>
                    <div style="padding: 15px 0;">
                        <strong>Suresh K. (Junnar)</strong> asked:
                        <p>"Is anyone selling reliable tomato seeds locally?"</p>
                        <small style="color: var(--secondary-color);">5 Replies ‚Ä¢ 1 hour ago</small>
                    </div>
                </div>
                <button class="btn-primary" style="margin-top: 20px;">Join Discussion</button>
            </div>
        </section>

    </main>

    <script>
        // ========== API CONFIGURATION ==========
        // ‚ö†Ô∏è PASTE YOUR API KEYS HERE:
        // Weatherstack (current weather, easy fallback) - https://weatherstack.com
        const WEATHERSTACK_KEY = '460963b8dd9f97172d64ee5367a15772'; // e.g. 'YOUR_WEATHERSTACK_ACCESS_KEY'
        // OpenWeather placeholder (not currently used by default)
         // Get from: https://openweathermap.org/api
        
        // ========== GLOBAL VARIABLES ==========
        let currentImageBase64 = null;
        let uploadedImageData = null;
        let currentSample = null;
        let lastDiagnosisText = '';
        
        // ========== MULTI-LANGUAGE SUPPORT ==========
        const i18n = {
            en: {
                analyzing: "ü§ñ Analyzing...",
                diagnosisPrompt: `You are an expert agricultural scientist. Analyze this plant/crop image and provide:
1. Plant disease name or "Healthy Plant"
2. Severity level (None, Low, Moderate, High, or Critical)
3. Brief description of symptoms
4. 3-4 specific treatment recommendations

Respond ONLY with valid JSON:
{
  "name": "disease name or Healthy Plant",
  "severity": "severity level",
  "description": "symptoms description",
  "treatments": ["treatment 1", "treatment 2", "treatment 3"]
}`
            },
            mr: {
                analyzing: "ü§ñ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...",
                diagnosisPrompt: `‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§ï‡•É‡§∑‡•Ä ‡§§‡§ú‡•ç‡§û ‡§Ü‡§π‡§æ‡§§. ‡§µ‡§®‡§∏‡•ç‡§™‡§§‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§Æ‡•á‡§ö‡•á ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ:
{
  "name": "‡§∞‡•ã‡§ó‡§æ‡§ö‡•á ‡§®‡§æ‡§µ",
  "severity": "‡§§‡•Ä‡§µ‡•ç‡§∞‡§§‡§æ",
  "description": "‡§≤‡§ï‡•ç‡§∑‡§£‡•á",
  "treatments": ["‡§â‡§™‡§ö‡§æ‡§∞ 1", "‡§â‡§™‡§ö‡§æ‡§∞ 2", "‡§â‡§™‡§ö‡§æ‡§∞ 3"]
}`
            },
            hi: {
                analyzing: "ü§ñ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...",
                diagnosisPrompt: `‡§Ü‡§™ ‡§ï‡•É‡§∑‡§ø ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§π‡•à‡§Ç‡•§ ‡§™‡•å‡§ß‡•á ‡§ï‡•Ä ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç:
{
  "name": "‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ",
  "severity": "‡§ó‡§Ç‡§≠‡•Ä‡§∞‡§§‡§æ",
  "description": "‡§≤‡§ï‡•ç‡§∑‡§£",
  "treatments": ["‡§â‡§™‡§ö‡§æ‡§∞ 1", "‡§â‡§™‡§ö‡§æ‡§∞ 2", "‡§â‡§™‡§ö‡§æ‡§∞ 3"]
}`
            }
        };
        
        // ========== HELPER FUNCTIONS ==========
        // Retry failed API calls
        
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }
        
        // ========== TRANSLATIONS ==========
        const translations = {
            en: {
                dashboard: "Dashboard",
                doctor: "AI Crop Doctor",
                market: "Mandi Rates",
                finance: "Loans & Schemes",
                equipment: "Equipments",
                myshop: "Sell Produce",
                learn: "Learning Hub",
                community: "Community",
                welcome: "Welcome back, here is your daily farming overview."
            },
            mr: {
                dashboard: "‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°",
                doctor: "‡§™‡•Ä‡§ï ‡§°‡•â‡§ï‡•ç‡§ü‡§∞",
                market: "‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§≠‡§æ‡§µ",
                finance: "‡§ï‡§∞‡•ç‡§ú ‡§Ü‡§£‡§ø ‡§Ø‡•ã‡§ú‡§®‡§æ",
                equipment: "‡§∂‡•á‡§§‡•Ä ‡§Ö‡§µ‡§ú‡§æ‡§∞‡•á",
                myshop: "‡§∂‡•á‡§§‡§Æ‡§æ‡§≤ ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä",
                learn: "‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞",
                community: "‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§ö‡§∞‡•ç‡§ö‡§æ",
                welcome: "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§Ü‡§π‡•á, ‡§Ø‡•á‡§•‡•á ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§¶‡•à‡§®‡§Ç‡§¶‡§ø‡§® ‡§∂‡•á‡§§‡•Ä‡§ö‡§æ ‡§Ü‡§¢‡§æ‡§µ‡§æ ‡§Ü‡§π‡•á."
            },
            hi: {
                dashboard: "‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°",
                doctor: "‡§´‡§∏‡§≤ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞",
                market: "‡§Æ‡§Ç‡§°‡•Ä ‡§≠‡§æ‡§µ",
                finance: "‡§ã‡§£ ‡§î‡§∞ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç",
                equipment: "‡§ï‡•É‡§∑‡§ø ‡§â‡§™‡§ï‡§∞‡§£",
                myshop: "‡§â‡§™‡§ú ‡§¨‡•á‡§ö‡•á‡§Ç",
                learn: "‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞",
                community: "‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø",
                welcome: "‡§µ‡§æ‡§™‡§∏‡•Ä ‡§™‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à, ‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§™‡§ï‡•Ä ‡§¶‡•à‡§®‡§ø‡§ï ‡§ñ‡•á‡§§‡•Ä ‡§ï‡§æ ‡§Ö‡§µ‡§≤‡•ã‡§ï‡§® ‡§π‡•à‡•§"
            }
        };

        // ========== NAVIGATION ==========
        function navigate(sectionId) {
            const sections = document.querySelectorAll('.section-page');
            sections.forEach(sec => sec.classList.remove('active'));

            const target = document.getElementById(sectionId);
            if(target) target.classList.add('active');

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });

            const currentLang = document.querySelector('.lang-switch button.active').innerText === '‡§Æ‡§∞‡§æ‡§†‡•Ä' ? 'mr' : 
                                (document.querySelector('.lang-switch button.active').innerText === '‡§π‡§ø‡§Ç‡§¶‡•Ä' ? 'hi' : 'en');
            setLanguage(currentLang);
            
            // Auto-load data based on page
            if (sectionId === 'dashboard') {
                setTimeout(() => fetchWeatherData(), 500);
            } else if (sectionId === 'market') {
                setTimeout(() => fetchMandiRates(), 500);
            }
        }

        // ========== LANGUAGE SWITCHING ==========
        function setLanguage(lang) {
            document.querySelectorAll('.lang-switch button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');

            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });

            document.getElementById('page-subtitle').innerText = translations[lang].welcome;

            const activeSection = document.querySelector('.section-page.active').id;
            if (translations[lang][activeSection]) {
                document.getElementById('page-title').innerText = translations[lang][activeSection];
            }
        }

        // ========== WEATHER API (Weatherstack) ==========
        async function fetchWeatherData() {
            const tempEl = document.getElementById('weatherTemp');
            const descEl = document.getElementById('weatherDesc');
            const locEl = document.getElementById('weatherLocation');
            const iconEl = document.getElementById('weatherIcon');

            // 1. Functions to handle success/error of location
            const success = async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                try {
                    // Always use Weatherstack for current weather. If key is missing, show unavailable state.
                    if (typeof WEATHERSTACK_KEY !== 'undefined' && WEATHERSTACK_KEY && WEATHERSTACK_KEY.trim() !== '') {
                        const wsRes = await fetch(`http://api.weatherstack.com/current?access_key=${WEATHERSTACK_KEY}&query=${lat},${lon}`);
                        const wsData = await wsRes.json();
                        if (!wsData || !wsData.current) throw new Error('No weather data from Weatherstack');

                        tempEl.innerText = Math.round(wsData.current.temperature) + '¬∞C';
                        const desc = (wsData.current.weather_descriptions && wsData.current.weather_descriptions[0]) || 'N/A';
                        descEl.innerText = desc;
                        iconEl.className = `fas ${mapDescToIcon(desc)}`;

                        // Reverse geocode (BigDataCloud) for location name
                        const cityRes = await fetch(
                            `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`
                        );
                        const cityData = await cityRes.json();
                        locEl.innerText = cityData.city || cityData.locality || "Your Farm";
                    } else {
                        // No Weatherstack key configured
                        tempEl.innerText = '--¬∞C';
                        descEl.innerText = 'Weatherstack key not configured';
                        iconEl.className = 'fas fa-exclamation-triangle';
                        locEl.innerText = 'Location';
                    }

                } catch (error) {
                    console.error("Weather API Error:", error);
                    locEl.innerText = "Weather unavailable";
                }
            };

            const error = () => {
                // Fallback if user denies location permission (Default: Pune)
                console.warn("Location access denied. Using default.");
                fetchWeatherDataByCoords(18.5204, 73.8567, "Pune (Default)");
            };

            // 2. Request User Location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                error();
            }
        }

        // Helper: Fetch for a specific default location using Weatherstack
        async function fetchWeatherDataByCoords(lat, lon, cityName) {
            try {
                const tempEl = document.getElementById('weatherTemp');
                const descEl = document.getElementById('weatherDesc');
                const iconEl = document.getElementById('weatherIcon');

                if (typeof WEATHERSTACK_KEY !== 'undefined' && WEATHERSTACK_KEY && WEATHERSTACK_KEY.trim() !== '') {
                    const wsRes = await fetch(`http://api.weatherstack.com/current?access_key=${WEATHERSTACK_KEY}&query=${lat},${lon}`);
                    const wsData = await wsRes.json();
                    if (!wsData || !wsData.current) throw new Error('No weather data from Weatherstack');

                    tempEl.innerText = Math.round(wsData.current.temperature) + '¬∞C';
                    const desc = (wsData.current.weather_descriptions && wsData.current.weather_descriptions[0]) || 'N/A';
                    descEl.innerText = desc;
                    iconEl.className = `fas ${mapDescToIcon(desc)}`;
                    document.getElementById('weatherLocation').innerText = cityName;
                } else {
                    tempEl.innerText = '--¬∞C';
                    descEl.innerText = 'Weatherstack key not configured';
                    iconEl.className = 'fas fa-exclamation-triangle';
                    document.getElementById('weatherLocation').innerText = cityName;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Helper: Map WMO codes to Icons & Text
        function getWeatherStatus(code) {
            // WMO Weather interpretation codes
            const map = {
                0: { desc: 'Clear Sky', icon: 'fa-sun' },
                1: { desc: 'Mainly Clear', icon: 'fa-cloud-sun' },
                2: { desc: 'Partly Cloudy', icon: 'fa-cloud' },
                3: { desc: 'Overcast', icon: 'fa-cloud' },
                45: { desc: 'Foggy', icon: 'fa-smog' },
                48: { desc: 'Depositing Rime Fog', icon: 'fa-smog' },
                51: { desc: 'Light Drizzle', icon: 'fa-cloud-rain' },
                53: { desc: 'Moderate Drizzle', icon: 'fa-cloud-rain' },
                55: { desc: 'Dense Drizzle', icon: 'fa-cloud-showers-heavy' },
                61: { desc: 'Slight Rain', icon: 'fa-cloud-rain' },
                63: { desc: 'Moderate Rain', icon: 'fa-cloud-rain' },
                65: { desc: 'Heavy Rain', icon: 'fa-cloud-showers-heavy' },
                71: { desc: 'Light Snow', icon: 'fa-snowflake' },
                73: { desc: 'Moderate Snow', icon: 'fa-snowflake' },
                75: { desc: 'Heavy Snow', icon: 'fa-snowflake' },
                80: { desc: 'Rain Showers', icon: 'fa-cloud-rain' },
                81: { desc: 'Heavy Showers', icon: 'fa-cloud-showers-heavy' },
                95: { desc: 'Thunderstorm', icon: 'fa-bolt' },
                96: { desc: 'Hailstorm', icon: 'fa-bolt' },
                99: { desc: 'Heavy Hailstorm', icon: 'fa-bolt' }
            };
            return map[code] || { desc: 'Unknown', icon: 'fa-cloud' };
        }

        // Map Weatherstack description text to FontAwesome icon classes
        function mapDescToIcon(desc) {
            if (!desc) return 'fa-cloud-sun';
            const d = desc.toLowerCase();
            if (d.includes('sun') || d.includes('clear')) return 'fa-sun';
            if (d.includes('cloud') || d.includes('overcast')) return 'fa-cloud';
            if (d.includes('rain') || d.includes('drizzle') || d.includes('shower')) return 'fa-cloud-showers-heavy';
            if (d.includes('thunder') || d.includes('storm')) return 'fa-bolt';
            if (d.includes('snow') || d.includes('sleet') || d.includes('hail')) return 'fa-snowflake';
            if (d.includes('fog') || d.includes('mist') || d.includes('haze')) return 'fa-smog';
            return 'fa-cloud-sun';
        }

        // ========== CROP DOCTOR - IMAGE UPLOAD ==========
        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert("Image too large! Please use an image under 5MB.");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                uploadedImageData = base64Data;
                currentImageBase64 = base64Data.split(',')[1];
                
                // Show preview
                document.getElementById('previewIcon').innerHTML = `
                    <img src="${base64Data}" style="max-width: 100%; max-height: 200px; border-radius: 10px; object-fit: contain;">
                `;
                document.getElementById('previewText').innerText = "Image Loaded! Ready to analyze.";
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('scanResult').style.display = 'none';
                
                // Clear demo sample selection
                currentSample = null;
                document.querySelectorAll('.sample-thumb').forEach(t => {
                    t.classList.remove('selected');
                    t.style.borderColor = '#ddd';
                    t.style.background = 'white';
                });
            };
            
            reader.readAsDataURL(file);
        }

        // ========== CROP DOCTOR - DEMO SAMPLES ==========
        const diseaseDB = {
            'healthy': {
                title: 'Healthy Crop',
                severity: 'None',
                severityColor: '#27ae60',
                confidence: '99%',
                desc: 'The plant shows no signs of disease or nutrient deficiency. Leaves are vibrant green with healthy veins.',
                treatments: ['Continue regular watering.', 'Maintain current fertilizer schedule.', 'Monitor for any changes.']
            },
            'nitrogen': {
                title: 'Nitrogen Deficiency',
                severity: 'Moderate',
                severityColor: '#f1c40f',
                confidence: '94%',
                desc: 'Leaves are turning yellow (chlorosis) starting from the tips and moving down the midrib. Older leaves are affected first.',
                treatments: ['Apply Nitrogen-rich fertilizer (Urea or Ammonium Sulfate).', 'Add composted manure to the soil.', 'Ensure soil is not waterlogged.']
            },
            'rust': {
                title: 'Leaf Rust (Fungal)',
                severity: 'High',
                severityColor: '#e67e22',
                confidence: '91%',
                desc: 'Orange-brown pustules (spots) are visible on the underside of leaves. Can cause leaf drop and yield loss.',
                treatments: ['Spray Propiconazole or Mancozeb fungicide.', 'Remove and burn infected leaves.', 'Avoid overhead watering to keep leaves dry.']
            },
            'pest': {
                title: 'Aphid Infestation',
                severity: 'Critical',
                severityColor: '#e74c3c',
                confidence: '88%',
                desc: 'Small insects visible on leaf undersides. Leaves may curl or become distorted. Sticky residue (honeydew) present.',
                treatments: ['Spray Neem Oil or Insecticidal Soap.', 'Introduce beneficial insects like Ladybugs.', 'Use yellow sticky traps.']
            }
        };

        function selectSample(type, el) {
            currentSample = type;
            uploadedImageData = null;
            currentImageBase64 = null;
            
            // Visual feedback
            document.querySelectorAll('.sample-thumb').forEach(t => {
                t.classList.remove('selected');
                t.style.borderColor = '#ddd';
                t.style.background = 'white';
            });
            el.classList.add('selected');
            el.style.borderColor = 'var(--secondary-color)';
            el.style.background = '#e8f5e9';
            
            // Update Preview
            const iconMap = {
                'healthy': ['fa-leaf', '#2ecc71'],
                'nitrogen': ['fa-leaf', '#f1c40f'],
                'rust': ['fa-leaf', '#e67e22'],
                'pest': ['fa-bug', '#e74c3c']
            };
            
            const prevIcon = document.getElementById('previewIcon');
            prevIcon.className = `fas ${iconMap[type][0]} big-icon`;
            prevIcon.style.color = iconMap[type][1];
            prevIcon.style.fontSize = '80px';
            
            document.getElementById('previewText').innerText = "Demo Sample Loaded. Ready to Analyze.";
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('scanResult').style.display = 'none';
        }

        // ========== CROP DOCTOR - ANALYSIS ==========
        async function startAnalysis() {
            if (!currentImageBase64 && !currentSample) {
                alert("Please upload an image or select a demo sample!");
                return;
            }
            
            const btn = document.getElementById('analyzeBtn');
            const frame = document.getElementById('scanFrame');
            const currentLangCode = document.querySelector('.lang-switch button.active').id.replace('btn-', '');
            
            btn.disabled = true;
            btn.innerText = i18n[currentLangCode]?.analyzing || "ü§ñ Analyzing...";
            frame.classList.add('scanning');
            
            if (currentImageBase64) {
                // Real image - use Groq API
                await runGroqAnalysis();
            } else if (currentSample) {
                // Demo sample - use fake data
                await runDemoAnalysis();
            }
            
            frame.classList.remove('scanning');
            btn.disabled = false;
            btn.innerText = "Start AI Diagnosis";
        }
        
        // Run Groq AI Analysis
    async function runGroqAnalysis() {
    // 1. Get the actual file from the input element
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    // Check if a file actually exists
    if (!file) {
        alert("Please upload an image first!");
        return;
    }

    // 2. Prepare the data to send to your local server
    const formData = new FormData();
    formData.append("image", file); // This MUST match upload.single("image") in server.js

    try {
        console.log('Sending request to http://localhost:3000/analyze...');
        // 3. Send to your Node.js backend
        const response = await fetch("http://localhost:3000/analyze", {
            method: "POST",
            body: formData
            // Note: Do NOT set headers manually; the browser handles it for FormData
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
            const errorData = await response.json();
            console.error('Server error:', errorData);
            throw new Error(errorData.error || 'Server error');
        }

        const data = await response.json();
        console.log('Analysis result:', data);
        
        // 4. Show the results on the screen
        displayDiagnosisResults(data);
        
    } catch (err) {
        console.error('Frontend Error:', err);
        alert(`Analysis failed: ${err.message}. Check if server is running on http://localhost:3000`);
        throw err; // This triggers the "Analysis failed" alert in startAnalysis()
    }
}



        
        // Run Demo Analysis
        async function runDemoAnalysis() {
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const demoData = diseaseDB[currentSample];
            const data = {
                name: demoData.title,
                severity: demoData.severity,
                description: demoData.desc,
                treatments: demoData.treatments,
                confidence: demoData.confidence
            };
            
            displayDiagnosisResults(data);
        }
        
        // Display Results
        function displayDiagnosisResults(data) {
            const severityColors = {
                'None': '#27ae60',
                'Low': '#27ae60',
                'Moderate': '#f1c40f',
                'High': '#e67e22',
                'Critical': '#e74c3c'
            };
            
            document.getElementById('resTitle').innerText = data.name;
            document.getElementById('resSeverity').innerText = `Severity: ${data.severity}`;
            document.getElementById('resSeverity').style.color = severityColors[data.severity] || '#f1c40f';
            document.getElementById('resDesc').innerText = data.description;
            
            const list = document.getElementById('resTreatment');
            list.innerHTML = '';
            (data.treatments || []).forEach(treatment => {
                const li = document.createElement('li');
                li.innerText = treatment;
                li.style.marginTop = '4px';
                list.appendChild(li);
            });
            
            if (data.confidence) {
                document.getElementById('resConfidence').innerText = `${data.confidence} Match`;
            } else {
                document.getElementById('resConfidence').innerText = 'AI Analysis';
            }
            
            document.getElementById('scanResult').style.display = 'block';
        }

        // ========== MANDI RATES API ==========
        async function fetchMandiRates() {
            const container = document.getElementById('mandiRatesContainer');
            container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-light);">üìä Loading market data...</p>';
            
            try {
                // Using a free agricultural data API
                // Note: You can replace this with data.gov.in API if you get their API key
                // For now, we'll show sample data that looks realistic
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Display sample mandi rates (you can replace with real API later)
                displayMandiRates(getSampleMandiData());
                
            } catch (error) {
                console.error('Mandi rates error:', error);
                container.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">‚ö†Ô∏è Could not load data. Showing cached rates.</p>';
                displayMandiRates(getSampleMandiData());
            }
        }

        function getSampleMandiData() {
            // Sample data - in production, this would come from an API
            return [
                { 
                    commodity: 'Onion (Kanda)', 
                    market: 'Pune APMC',
                    icon: 'fa-circle',
                    iconColor: '#8B4513',
                    min_price: '1800', 
                    max_price: '2500', 
                    modal_price: '2150',
                    trend: '+2.5%',
                    trendUp: true
                },
                { 
                    commodity: 'Tomato', 
                    market: 'Mumbai',
                    icon: 'fa-circle',
                    iconColor: '#FF6347',
                    min_price: '800', 
                    max_price: '1400', 
                    modal_price: '1100',
                    trend: '-1.2%',
                    trendUp: false
                },
                { 
                    commodity: 'Wheat (Gahu)', 
                    market: 'Nashik',
                    icon: 'fa-seedling',
                    iconColor: '#DAA520',
                    min_price: '2800', 
                    max_price: '3200', 
                    modal_price: '3050',
                    trend: '+0.8%',
                    trendUp: true
                },
                { 
                    commodity: 'Rice (Paddy)', 
                    market: 'Pune APMC',
                    icon: 'fa-seedling',
                    iconColor: '#F5DEB3',
                    min_price: '2200', 
                    max_price: '2600', 
                    modal_price: '2400',
                    trend: '+1.5%',
                    trendUp: true
                },
                { 
                    commodity: 'Cotton', 
                    market: 'Akola',
                    icon: 'fa-cloud',
                    iconColor: '#F0F8FF',
                    min_price: '5500', 
                    max_price: '6200', 
                    modal_price: '5850',
                    trend: '-0.5%',
                    trendUp: false
                },
                { 
                    commodity: 'Soybean', 
                    market: 'Latur',
                    icon: 'fa-circle',
                    iconColor: '#8FBC8F',
                    min_price: '4000', 
                    max_price: '4600', 
                    modal_price: '4300',
                    trend: '+3.2%',
                    trendUp: true
                },
                { 
                    commodity: 'Sugarcane', 
                    market: 'Kolhapur',
                    icon: 'fa-leaf',
                    iconColor: '#90EE90',
                    min_price: '2600', 
                    max_price: '3000', 
                    modal_price: '2800',
                    trend: '+0.3%',
                    trendUp: true
                },
                { 
                    commodity: 'Potato (Batata)', 
                    market: 'Pune APMC',
                    icon: 'fa-circle',
                    iconColor: '#D2691E',
                    min_price: '500', 
                    max_price: '900', 
                    modal_price: '700',
                    trend: '-2.1%',
                    trendUp: false
                }
            ];
        }

        function displayMandiRates(records) {
            const container = document.getElementById('mandiRatesContainer');
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-light);">No data available</p>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table class="market-table" style="width: 100%; border-collapse: collapse;">';
            html += `
                <thead style="background: var(--primary-color); color: white;">
                    <tr>
                        <th style="padding: 15px; text-align: left;">Commodity</th>
                        <th style="padding: 15px; text-align: left;">Market</th>
                        <th style="padding: 15px; text-align: right;">Min (‚Çπ/Qtl)</th>
                        <th style="padding: 15px; text-align: right;">Max (‚Çπ/Qtl)</th>
                        <th style="padding: 15px; text-align: right;">Modal (‚Çπ/Qtl)</th>
                        <th style="padding: 15px; text-align: center;">24h Trend</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            records.forEach((record, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const trendColor = record.trendUp ? 'var(--secondary-color)' : '#e74c3c';
                const trendIcon = record.trendUp ? 'fa-arrow-up' : 'fa-arrow-down';
                
                html += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px; font-weight: 600;">
                            <i class="fas ${record.icon}" style="color: ${record.iconColor}; margin-right: 8px;"></i>
                            ${record.commodity}
                        </td>
                        <td style="padding: 12px; color: var(--text-light);">${record.market}</td>
                        <td style="padding: 12px; text-align: right;">‚Çπ${record.min_price}</td>
                        <td style="padding: 12px; text-align: right;">‚Çπ${record.max_price}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--secondary-color); font-size: 16px;">
                            ‚Çπ${record.modal_price}
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: ${trendColor};">
                            <i class="fas ${trendIcon}"></i> ${record.trend}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            html += `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                    <p style="color: var(--text-light); font-size: 12px; margin: 0;">
                        üìÖ Last updated: ${new Date().toLocaleString('en-IN', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit'
                        })}
                    </p>
                    <p style="color: var(--text-light); font-size: 11px; margin: 0; font-style: italic;">
                        üí° Prices are indicative and may vary at actual mandi
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ========== FINANCE CALCULATOR ==========
        function calculateLoan() {
            const acres = parseFloat(document.getElementById('landInput').value);
            const scaleOfFinance = parseInt(document.getElementById('cropInput').value);
            const resultDisplay = document.getElementById('loanResult');
            const amountDisplay = document.getElementById('amountDisplay');

            if (isNaN(acres) || acres <= 0) {
                alert("Please enter a valid land size in acres.");
                return;
            }

            const totalLoan = acres * scaleOfFinance;
            amountDisplay.innerText = "‚Çπ" + totalLoan.toLocaleString('en-IN');
            resultDisplay.style.display = 'block';
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            navigate('dashboard');
            fetchWeatherData(); // Load weather on startup
        });

    </script>
</body>
</html>